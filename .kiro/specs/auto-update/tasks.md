# 自动更新功能实施任务列表

- [x] 1. 配置 Tauri Updater 插件和依赖
  - [x] 1.1 在 `src-tauri/Cargo.toml` 中添加 `tauri-plugin-updater` 依赖
    - 添加版本 2.0 的 updater 插件
    - 添加 `tauri-plugin-process` 用于应用重启
    - _需求: 1.1, 3.1, 3.2_

  - [x] 1.2 在前端 `package.json` 中添加必要的 Tauri 插件包
    - 添加 `@tauri-apps/plugin-updater`
    - 添加 `@tauri-apps/plugin-process`
    - _需求: 1.1, 2.3_

  - [x] 1.3 在 `src-tauri/src/lib.rs` 中注册 updater 插件
    - 导入并注册 updater 插件到 Tauri builder
    - 配置插件初始化选项
    - _需求: 1.1, 6.1_

  - [x] 1.4 配置 `src-tauri/tauri.conf.json` 的 updater 设置
    - 设置 `bundle.updater.active` 为 true
    - 配置更新服务器端点 URL（使用占位符）
    - 添加公钥配置字段（稍后填入实际密钥）
    - _需求: 1.1, 3.1, 6.2_

- [x] 2. 实现更新检查和状态管理
  - [x] 2.1 创建更新工具函数 `src/lib/updater.ts`
    - 实现 `checkForUpdates()` 函数调用 Tauri updater API
    - 实现 `downloadAndInstall()` 函数处理下载和安装
    - 实现错误处理和类型定义
    - _需求: 1.1, 1.5, 2.3, 3.2_

  - [x] 2.2 创建更新上下文 `src/contexts/UpdateContext.tsx`
    - 定义 UpdateContext 接口和状态类型
    - 实现 Context Provider 组件
    - 实现更新检查逻辑（启动时和定时检查）
    - 管理更新状态（可用、下载中、进度等）
    - 处理错误和重试逻辑
    - _需求: 1.1, 1.2, 1.3, 1.4, 2.1, 2.4_

  - [x] 2.3 在 `src/App.tsx` 中集成 UpdateContext Provider
    - 包裹应用根组件
    - 确保所有子组件可以访问更新状态
    - _需求: 1.1, 1.3_

- [x] 3. 创建更新对话框 UI 组件
  - [x] 3.1 实现 `src/components/UpdateDialog.tsx` 组件
    - 创建对话框基础结构使用现有的 AlertDialog 组件
    - 显示版本号和更新说明
    - 实现"立即更新"和"稍后提醒"按钮
    - 显示下载进度条（使用进度百分比）
    - 处理不同状态的 UI 显示（检查中、可用、下载中、错误）
    - _需求: 2.1, 2.2, 2.3, 2.5, 4.1_
  - [x] 3.2 在 App 组件中集成 UpdateDialog
    - 从 UpdateContext 获取状态
    - 根据更新状态控制对话框显示
    - 连接对话框按钮到更新操作
    - _需求: 1.3, 2.1, 2.4_

- [x] 4. 在设置页面添加更新管理功能
  - [x] 4.1 扩展 `src/pages/Settings.tsx` 添加更新管理部分
    - 在现有设置页面添加"关于"或"更新"区域
    - 显示当前应用版本号（从 package.json 读取）
    - 添加"检查更新"按钮
    - 显示最后检查时间
    - 显示当前更新状态（检查中、已是最新、有更新可用）
    - _需求: 5.1, 5.2, 5.3, 5.4, 5.5_

  - [x] 4.2 实现手动检查更新功能
    - 连接"检查更新"按钮到 UpdateContext 的检查方法
    - 显示检查结果（最新版本或有更新）
    - 处理检查失败的错误提示
    - _需求: 5.3, 5.4_

- [x] 5. 实现版本比较和工具函数
  - [x] 5.1 创建 `src/lib/version.ts` 版本工具
    - 实现语义化版本比较函数 `compareVersions()`
    - 实现版本号格式化函数 `formatVersion()`
    - 处理预发布版本和构建号
    - _需求: 1.5_
  - [x] 5.2 实现本地存储管理
    - 在 `src/lib/updater.ts` 中添加 localStorage 操作
    - 保存最后检查时间
    - 保存用户忽略的版本号
    - 读取和更新更新设置
    - _需求: 2.4, 5.5_

- [x] 6. 实现错误处理和用户反馈
  - [x] 6.1 在 UpdateContext 中实现完整的错误处理
    - 定义错误类型枚举（网络、解析、验证、下载、安装）
    - 实现错误分类和处理逻辑
    - 对网络错误静默处理
    - 对验证错误显示警告
    - 对下载错误提供重试选项
    - _需求: 1.4, 3.3, 4.5_

  - [x] 6.2 在 UpdateDialog 中显示错误信息
    - 根据错误类型显示不同的提示消息
    - 提供重试按钮（针对可恢复的错误）
    - 提供详细错误信息（开发模式）
    - _需求: 1.4, 3.3_

- [x] 7. 配置构建和签名流程
  - [x] 7.1 生成更新签名密钥对
    - 使用 Tauri CLI 生成密钥对
    - 将公钥添加到 `tauri.conf.json`
    - 安全保存私钥（不提交到版本控制）
    - 在 `.gitignore` 中添加私钥路径
    - _需求: 3.2, 3.3_

  - [x] 7.2 创建构建脚本 `scripts/build-release.sh`
    - 实现跨平台构建命令
    - 自动签名生成的安装包
    - 生成构建产物清单
    - _需求: 6.1, 6.4_

  - [x] 7.3 创建更新清单生成脚本 `scripts/generate-manifest.js`
    - 读取版本号和构建信息
    - 生成符合 Tauri 格式的 JSON 清单
    - 包含所有平台的下载链接和签名
    - 计算并添加文件哈希值
    - _需求: 3.4, 6.2, 6.3_

- [x] 8. 实现更新安装和重启流程
  - [x] 8.1 在 `src/lib/updater.ts` 中完善安装逻辑
    - 实现下载完成后的安装触发
    - 调用 Tauri process 插件重启应用
    - 处理安装失败的回滚逻辑
    - _需求: 4.1, 4.2, 4.3, 4.5_
  - [x] 8.2 实现首次启动检测和更新成功提示
    - 检测应用版本是否刚更新
    - 在首次启动时显示更新成功消息
    - 清除更新标记
    - _需求: 4.4_

- [x] 9. 添加更新功能的集成测试
  - [x] 9.1 创建更新流程的模拟测试
    - 模拟更新检查响应
    - 测试版本比较逻辑
    - 测试状态转换
    - _需求: 1.5, 2.1_

  - [x] 9.2 测试错误处理场景
    - 测试网络失败处理
    - 测试无效清单处理
    - 测试签名验证失败
    - _需求: 1.4, 3.3_

- [x] 10. 文档和部署指南
  - [x] 10.1 创建更新服务器部署文档
    - 说明更新清单的托管方式
    - 提供 GitHub Releases 配置示例
    - 提供自建服务器配置示例
    - _需求: 3.1, 6.2_

  - [x] 10.2 创建发布流程文档
    - 说明如何构建和签名发布版本
    - 说明如何生成和上传更新清单
    - 说明版本号管理规范
    - _需求: 6.1, 6.2, 6.4_
