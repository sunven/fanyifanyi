name: Debug Signing Keys

on:
  workflow_dispatch: # 手动触发

jobs:
  debug-secrets:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Debug signing keys
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: |
          echo "=== Debug Signing Keys ==="
          echo ""
          echo "TAURI_SIGNING_PRIVATE_KEY:"
          if [ -z "$TAURI_SIGNING_PRIVATE_KEY" ]; then
            echo "  ❌ EMPTY or NOT SET"
          else
            echo "  ✓ Length: ${#TAURI_SIGNING_PRIVATE_KEY}"
            echo "  First 50 chars: ${TAURI_SIGNING_PRIVATE_KEY:0:50}"
            echo "  Last 10 chars: ${TAURI_SIGNING_PRIVATE_KEY: -10}"
            if [[ "$TAURI_SIGNING_PRIVATE_KEY" == *$'\n'* ]]; then
              echo "  ❌ Contains newline (ERROR!)"
            else
              echo "  ✓ No newline"
            fi
          fi
          echo ""
          echo "TAURI_SIGNING_PRIVATE_KEY_PASSWORD:"
          if [ -z "$TAURI_SIGNING_PRIVATE_KEY_PASSWORD" ]; then
            echo "  ❌ EMPTY or NOT SET"
          else
            echo "  ✓ Length: ${#TAURI_SIGNING_PRIVATE_KEY_PASSWORD}"
            echo "  Value: [${TAURI_SIGNING_PRIVATE_KEY_PASSWORD}]"
          fi
          echo ""
          echo "Expected values:"
          echo "  Password length: 32"
          echo "  Private key length: 344"
          echo "========================="

      - name: Test signing
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: |
          echo "test content" > /tmp/test.txt
          pnpm tauri signer sign /tmp/test.txt \
            --private-key-path <(echo "$TAURI_SIGNING_PRIVATE_KEY") \
            --password "$TAURI_SIGNING_PRIVATE_KEY_PASSWORD"
